{% extends 'base.html' %}
{% load static %}
{% block title %}HR Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3>HR Dashboard â€” Announcements</h3>

  <!-- Composer (HR only) -->
  {% if user.role == "HR" %}
  <div class="card mb-4">
    <div class="card-body">
      <form id="announce-form" method="post" action="{% url 'communications:post_announcement' %}">
        {% csrf_token %}
        {{ form.content }}
        <div class="mt-2">
          <button type="submit" class="btn btn-primary">Publish Announcement</button>
        </div>
      </form>
      <div id="announce-errors" class="text-danger mt-2"></div>
    </div>
  </div>
  {% endif %}

  <!-- Recent announcements list (read-only) -->
  <div id="announcements-list">
    {% for m in messages %}
      <div class="card mb-2">
        <div class="card-body">
          <small class="text-muted">{{ m.created_at }}</small>
          <h6 class="mt-1">{{ m.sender.username if m.sender else "HR" }}</h6>
          <p>{{ m.content }}</p>
        </div>
      </div>
    {% empty %}
      <p>No announcements yet.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Client: POST announcement via fetch (HR only)
  (function(){
    const form = document.getElementById('announce-form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = new FormData(form);
        const resp = await fetch("{% url 'communications:post_announcement' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: data
        });
        const json = await resp.json();
        if (json.success) {
          // optimistic: append to list
          const div = document.createElement('div');
          div.className = 'card mb-2';
          div.innerHTML = `<div class="card-body"><small class="text-muted">${new Date().toLocaleString()}</small><h6 class="mt-1">{{ request.user.username }}</h6><p>${json.message ? "" : ""}</p></div>`;
          // Clear form
          form.querySelector('textarea').value = '';
          document.getElementById('announce-errors').innerHTML = '';
          // server will broadcast and clients will receive via websocket -> so nothing else required
        } else {
          const errors = json.errors || {content: ["Invalid input"]};
          let html = '';
          for (let k in errors) html += `<div>${k}: ${errors[k].join(', ')}</div>`;
          document.getElementById('announce-errors').innerHTML = html;
        }
      });
    }
  })();
</script>

{% endblock %}
