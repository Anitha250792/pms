{% extends "base.html" %}
{% block title %}Dashboard - Overview{% endblock %}
{% block content %}

<style>
  /* üé® Project Card Styling */
  .project-card {
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.9);
    border-radius: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.22);
    transition: all 0.25s ease;
    border: none;
    opacity: 0;
    transform: translateY(25px);
  }
  .project-card.visible {
    opacity: 1;
    animation: fadeInUp 0.6s ease forwards, glowPulse 2s infinite alternate;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes glowPulse {
    from { box-shadow: 0 0 0 rgba(0,0,0,0); }
    to { box-shadow: 0 0 18px rgba(0, 205, 255, 0.6); }
  }

  /* Filter Styling */
  .filter-select {
    background: #ffffffdc;
    border-radius: 10px;
    font-weight: 600;
  }

  .badge-pill {
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    font-size: 0.8rem;
  }

  .chart-container {
    height: 350px;
  }
</style>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="fw-bold text-white mb-1">üåê Global Project Overview</h2>
    <p class="text-light mb-0" style="opacity:.8;">Read-only view for every role</p>
  </div>

  <a href="{% url 'dashboard:select_role' %}" class="btn btn-warning fw-semibold shadow-sm">
    Choose Your Role
  </a>
</div>

<!-- üîé Filters -->
<div class="row mb-4">
  <div class="col-md-3">
    <select id="priorityFilter" class="form-select shadow-sm filter-select">
      <option value="">All Priorities</option>
      <option value="High">High</option>
      <option value="Medium">Medium</option>
      <option value="Low">Low</option>
    </select>
  </div>

  <div class="col-md-3">
    <select id="statusFilter" class="form-select shadow-sm filter-select">
      <option value="">All Status</option>
      <option value="Pending">Pending</option>
      <option value="In Progress">In Progress</option>
      <option value="Completed">Completed</option>
      <option value="On Hold">On Hold</option>
    </select>
  </div>

  <div class="col-md-3">
    <button id="resetFilters" class="btn btn-secondary fw-semibold shadow-sm w-100">
      Reset Filters
    </button>
  </div>
</div>

{% if projects %}
  <div class="row" id="projectsContainer">
    {% for p in projects %}
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card project-card h-100 p-3"
             data-priority="{{ p.priority }}"
             data-status="{{ p.status }}">

          <!-- Name + Status -->
          <div class="d-flex justify-content-between mb-1">
            <h5 class="fw-bold mb-0">{{ p.name }}</h5>
            <span class="badge badge-pill
              {% if p.status == 'Completed' %} bg-success
              {% elif p.status == 'In Progress' %} bg-warning text-dark
              {% elif p.status == 'On Hold' %} bg-secondary
              {% else %} bg-info text-dark
              {% endif %}">{{ p.status }}</span>
          </div>

          <!-- Description -->
          <p class="text-muted">{{ p.description|default:"No description"|truncatechars:120 }}</p>

          <!-- Manager -->
          <p><strong>Manager:</strong> {{ p.owner.username }}</p>

          <!-- Team Members -->
          <p><strong>Team:</strong>
            {% if p.assigned_to.exists %}
              {% for m in p.assigned_to.all %}
                {{ m.username }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% else %}
              <span class="text-muted">Yet to assign</span>
            {% endif %}
          </p>

          <!-- Priority -->
          <p><strong>Priority:</strong>
            {% if p.priority == "High" %}
              <span class="badge badge-pill bg-danger">High</span>
            {% elif p.priority == "Medium" %}
              <span class="badge badge-pill bg-warning text-dark">Medium</span>
            {% else %}
              <span class="badge badge-pill bg-success">Low</span>
            {% endif %}
          </p>

          <!-- Progress Bar -->
          <div class="progress mb-2" style="height:16px;">
            <div class="progress-bar" style="width:{{ p.completion }}%;background:{{ p.progress_color }};">
            </div>
          </div>

          <!-- Dates -->
          <small><strong>Start:</strong> {{ p.assigned_date|date:"d M Y" }}</small><br>
          <small><strong>End:</strong> {{ p.delivery_date|date:"d M Y" }}</small>

        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- üìä Charts Section -->
<hr class="my-5">
<div class="row justify-content-center">

  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center text-primary mb-3">Project Priority Overview</h5>
      <div class="chart-container">
        <canvas id="priorityChart"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center text-success mb-3">Task Status Overview</h5>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const projects = document.querySelectorAll(".project-card");
setTimeout(() => projects.forEach(card => card.classList.add("visible")), 100);

const priorityFilter = document.getElementById("priorityFilter");
const statusFilter = document.getElementById("statusFilter");
const resetFilters = document.getElementById("resetFilters");

function applyFilters() {
  const pVal = priorityFilter.value;
  const sVal = statusFilter.value;

  projects.forEach(card => {
    const match =
      (!pVal || card.dataset.priority === pVal) &&
      (!sVal || card.dataset.status === sVal);

    card.parentElement.style.display = match ? "block" : "none";
  });

  updateCharts();
}

priorityFilter.onchange = statusFilter.onchange = applyFilters;
resetFilters.onclick = () => {
  priorityFilter.value = "";
  statusFilter.value = "";
  applyFilters();
};

// Charts
let pChart, sChart;
function updateCharts() {
  const visible = [...projects].filter(c => c.parentElement.style.display !== "none");
  const pc = { High: 0, Medium: 0, Low: 0 };
  const sc = { "Pending":0, "In Progress":0, "Completed":0, "On Hold":0 };

  visible.forEach(c => { pc[c.dataset.priority]++; sc[c.dataset.status]++; });

  if (pChart) pChart.destroy();
  if (sChart) sChart.destroy();

  pChart = new Chart(priorityChart, {
    type:"doughnut",
    data:{labels:Object.keys(pc),datasets:[{data:Object.values(pc)}]},
    options:{animation:{animateScale:true},cutout:"65%"}
  });

  sChart = new Chart(statusChart, {
    type:"bar",
    data:{labels:Object.keys(sc),datasets:[{data:Object.values(sc)}]},
    options:{animation:{duration:1200},scales:{y:{beginAtZero:true}}}
  });
}
updateCharts();
</script>

{% endblock %}
