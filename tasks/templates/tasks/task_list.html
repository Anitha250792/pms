{% extends 'base.html' %}
{% block title %}My Modules{% endblock %}

{% block content %}
<style>
  @keyframes fadeInUp { from{opacity:0;transform:translateY(25px);} to{opacity:1;transform:translateY(0);} }

  .tasks-container {
    margin-top:90px;
    animation:fadeInUp 1s;
    background:rgba(255,255,255,0.9);
    padding:25px;
    border-radius:20px;
  }

  .filter-box {
    background:white; padding:15px; border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
    margin-bottom:15px;
  }

  .overdue { color:red; font-weight:700; }
  .due-soon { color:#e65100; font-weight:700; }
</style>

<div class="container tasks-container">

  <h2 class="text-center text-primary fw-bold mb-4">Modules</h2>

  <!-- SEARCH + FILTERS + SORT -->
  <div class="filter-box">
    <form method="GET" class="row g-2">

      <div class="col-md-3">
        <input type="text" name="q" placeholder="Search…" value="{{ request.GET.q }}" class="form-control">
      </div>

      <div class="col-md-2">
        <select name="priority" class="form-control">
          <option value="">Priority</option>
          <option value="High" {% if request.GET.priority == "High" %}selected{% endif %}>High</option>
          <option value="Medium" {% if request.GET.priority == "Medium" %}selected{% endif %}>Medium</option?
          <option value="Low" {% if request.GET.priority == "Low" %}selected{% endif %}>Low</option>
        </select>
      </div>

      <div class="col-md-2">
        <select name="status" class="form-control">
          <option value="">Status</option>
          <option value="Pending" {% if request.GET.status == "Pending" %}selected{% endif %}>Pending</option>
          <option value="In Progress" {% if request.GET.status == "In Progress" %}selected{% endif %}>In Progress</option>
          <option value="Completed" {% if request.GET.status == "Completed" %}selected{% endif %}>Completed</option>
        </select>
      </div>

      <div class="col-md-3">
        <select name="sort" class="form-control">
          <option value="">Sort By</option>
          <option value="title" {% if request.GET.sort == "title" %}selected{% endif %}>Title (A–Z)</option>
          <option value="-title" {% if request.GET.sort == "-title" %}selected{% endif %}>Title (Z–A)</option>
          <option value="priority" {% if request.GET.sort == "priority" %}selected{% endif %}>Priority</option>
          <option value="-due_date" {% if request.GET.sort == "-due_date" %}selected{% endif %}>Latest Due Date</option>
        </select>
      </div>

      <div class="col-md-2">
        <button class="btn btn-primary w-100"><i class="bi bi-search"></i> Apply</button>
      </div>

    </form>
  </div>

  {% if tasks %}
    <div class="table-responsive">
      <table class="table text-center align-middle">
        <thead class="table-primary">
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Completion</th>
            <th>Due Date</th>
            {% if request.user.role not in "HR Manager" %}
              <th>Actions</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% for task in tasks %}
          <tr>
            <td class="fw-semibold">
              <a href="{% if request.user.role in 'HR Manager' %}
                         {% url 'tasks:task_detail_readonly' task.pk %}
                       {% else %}
                         {% url 'tasks:task_detail' task.pk %}
                       {% endif %}"
                 class="text-decoration-none text-dark">
                {{ task.title }}
              </a>
            </td>

            <td>
              {% if task.status == "Completed" %}<span class="badge bg-success">Completed</span>
              {% elif task.status == "In Progress" %}<span class="badge bg-warning text-dark">In Progress</span>
              {% else %}<span class="badge bg-danger">Pending</span>
              {% endif %}
            </td>

            <td>
              {% if task.priority == "High" %}<span class="badge bg-danger">High</span>
              {% elif task.priority == "Medium" %}<span class="badge bg-warning text-dark">Medium</span>
              {% else %}<span class="badge bg-success">Low</span>
              {% endif %}
            </td>

            <td>
              <div class="progress">
                <div class="progress-bar
                {% if task.completion < 40 %} bg-danger
                {% elif task.completion < 70 %} bg-warning
                {% else %} bg-success {% endif %}"
                style="width: {{ task.completion }}%">
                </div>
              </div>
              <small>{{ task.completion }}%</small>
            </td>

            <td>
              {{ task.due_date|date:"M d, Y" }}
              {% if task.due_date %}
                {% now "U" as nowTs %}
                {% with due=task.due_date|date:"U" %}
                  {% if due < nowTs %}
                    <div class="overdue">⚠️ Overdue!</div>
                  {% elif due < nowTs|add:"172800" %}
                    <div class="due-soon">⏳ Due Soon</div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>

            {% if request.user.role not in "HR Manager" %}
            <td>
              <a href="{% url 'tasks:task_edit' task.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
              <form action="{% url 'tasks:task_delete' task.pk %}" method="POST" style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  {% else %}
    <div class="alert alert-warning text-center">No Modules Found</div>
  {% endif %}

</div>
{% endblock %}
