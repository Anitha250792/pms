{% extends 'base.html' %}
{% block title %}üìÅ {{ project.name }}{% endblock %}

{% block content %}
<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .project-detail-container {
    max-width: 900px;
    margin: 70px auto;
    padding: 2rem;
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 0 25px rgba(0,0,0,0.2);
    animation: fadeInUp 1s ease;
    color: #000;
  }

  .project-title {
    text-align: center;
    font-weight: 700;
    color: #1976d2;
    text-shadow: 0 0 10px rgba(25,118,210,0.3);
  }

  .project-description {
    color: #555;
    font-size: 1.05rem;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .list-group-item {
    background: rgba(240,248,255,0.8);
    border: none;
    border-radius: 12px !important;
    margin-bottom: 10px;
  }

  .progress {
    height: 25px;
    border-radius: 15px;
    overflow: hidden;
  }

  .progress-bar {
    font-weight: bold;
    color: #fff;
    transition: width 1.2s ease-in-out;
  }

  .btn-save {
    background: linear-gradient(45deg,#26c6da,#42a5f5);
    color: white !important;
    border: none;
    padding: 6px 12px;
    font-weight: 600;
    border-radius: 8px;
  }

  .btn-delete {
    background: #e53935;
    color: white !important;
    padding: 6px 10px;
    font-weight: 600;
    border-radius: 8px;
  }

  .gallery-image {
    cursor: pointer;
    transition: 0.3s;
  }
  .gallery-image:hover {
    transform: scale(1.05);
  }

  #lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  #lightbox img {
    max-width: 90%;
    max-height: 80%;
  }
</style>

<div class="project-detail-container">

  <h2 class="project-title">{{ project.name }}</h2>
  <p class="project-description">{{ project.description }}</p>

  <hr>

  <h5 class="text-primary fw-bold mb-2">üìå Project Information</h5>

  <ul class="list-group mb-4">
    <li class="list-group-item"><strong>Assigned Date:</strong> {{ project.assigned_date|date:"M d, Y" }}</li>
    <li class="list-group-item"><strong>Delivery Date:</strong> {{ project.delivery_date|date:"M d, Y" }}</li>
    <li class="list-group-item"><strong>Assigned To:</strong> {{ project.assigned_to.username|default:"Not Assigned" }}</li>
  </ul>

  <!-- STATUS -->
  <div class="list-group-item mb-3">
    <strong>Status:</strong>
    <form id="statusForm">
      {% csrf_token %}
      <select name="status">
        <option value="Pending" {% if project.status == "Pending" %}selected{% endif %}>Pending</option>
        <option value="In Progress" {% if project.status == "In Progress" %}selected{% endif %}>In Progress</option>
        <option value="Completed" {% if project.status == "Completed" %}selected{% endif %}>Completed</option>
        <option value="On Hold" {% if project.status == "On Hold" %}selected{% endif %}>On Hold</option>
      </select>
      {% if request.user.role not in "HR Manager" %}
      <button class="btn-save">Save</button>
      {% endif %}
    </form>
  </div>

  <!-- REMARKS (Team Member Only) -->
  {% if request.user.role not in "HR Manager" %}
  <div class="list-group-item mb-4">
    <form method="POST">
      {% csrf_token %}
      <label class="fw-bold">Remarks:</label>
      <textarea name="remark" rows="3" class="form-control">{{ project.remark }}</textarea>
      <button class="btn btn-primary mt-2">Update</button>
    </form>
  </div>
  {% endif %}

  <!-- COMPLETION -->
  <div class="list-group-item mb-3">
    <strong>Completion:</strong>
    <form id="completionForm">
      {% csrf_token %}
      <input type="number" name="completion" min="0" max="100" value="{{ project.completion }}">
      {% if request.user.role not in "HR Manager" %}
      <button class="btn-save">Save</button>
      {% endif %}
    </form>
  </div>

  <div class="progress mb-4">
    <div id="progressBar"
         class="progress-bar"
         style="width: {{ project.completion }}%;
                background:{% if project.completion < 40 %}#e53935{% elif project.completion < 70 %}#fbc02d{% else %}#43a047{% endif %}">
      {{ project.completion }}%
    </div>
  </div>

  <!-- IMAGES -->
  <hr class="my-4">
  <h5 class="text-primary mb-3"><i class="bi bi-images"></i> Project Images</h5>

  {% if images %}
  <div class="row g-3">
    {% for img in images %}
    <div class="col-md-4 text-center">
      <img src="{{ img.image.url }}" class="img-fluid rounded gallery-image">
      {% if request.user.role not in "HR Manager" %}
      <form action="{% url 'projects:delete_project_image' img.id %}" method="POST" class="mt-1">
        {% csrf_token %}
        <button class="btn-delete btn-sm"><i class="bi bi-trash"></i></button>
      </form>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-muted">No images uploaded yet.</p>
  {% endif %}

  {% if request.user.role not in "HR Manager" %}
  <hr>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn-save">Upload</button>
  </form>
  {% endif %}

  <!-- LIVE LINK -->
  {% if project.live_link %}
  <div class="text-center mt-4">
    <a href="{{ project.live_link }}" target="_blank" class="btn btn-info">üåê View Live Project</a>
  </div>
  {% endif %}

  {% if request.user.role not in "HR Manager" %}
  <form method="POST" class="mt-3">
    {% csrf_token %}
    <label class="fw-bold">Live Link:</label>
    <input type="url" name="live_link" class="form-control" value="{{ project.live_link }}">
    <button class="btn-save mt-2">Save</button>
  </form>
  {% endif %}

  <div class="text-center mt-4">
    <a href="{% url 'projects:project_list' %}" class="btn btn-secondary">‚Üê Back</a>
  </div>

</div>

<!-- LIGHTBOX -->
<div id="lightbox"><img src=""></div>

<script>
document.querySelectorAll(".gallery-image").forEach(img => {
  img.onclick = () => {
    document.querySelector("#lightbox img").src = img.src;
    document.getElementById("lightbox").style.display = "flex";
  };
});
document.getElementById("lightbox").onclick = () =>
  (document.getElementById("lightbox").style.display = "none");
</script>
{% endblock %}
